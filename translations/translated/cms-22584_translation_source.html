<h1>Contato com Depuração Moderna: Parte 2</h1>

<p>Na parte 1, vimos como escrever e executar código JavaScript usando as Ferramentas para Desenvolvedores. Na parte 2, veremos como depurar código JavaScript e como adotar um fluxo de trabalho de tal modo que o diagnóstico e resolução de erros no JavaScript seja mais eficiente.</p>

<h2>Depurando Código JavaScript Usando as Ferramentas para Desenvolvedores</h2>

<h3>Palavra-chave <em>Debugger</em></h3>

<p>Você pode usar a palavra-chave <code><em>debugger</em></code>, diretamente, em seu código para invocar as capacidades de depuração (se houver) do ambiente de execução do JavaScript. Adicionar a palavra-chave <code>debugger</code> em seu código tem o mesmo efeito que configurar pontos de parada através da interface de usuário das Ferramentas para Desenvolvedores, manualmente. No Chrome, a palavra-chave <code>debugger</code> não terá qualquer efeito enquanto as Ferramentas para Desenvolvedores estiverem fechadas.</p>

<h3>Controles de Depuração</h3>

<p>Os controles de depuração proveem um controle fino sobre o fluxo de depuração. Use-os enquanto estiver parado em um ponto de parada para navegar efetivamente pelo código JavaScript. Cada controle de depuração listado abaixo, corresponde a um botão nas Ferramentas para Desenvolvedores que você pode selecionar enquanto estiver parado em um ponto de parada.</p>

<h4><em>Continue</em></h4>

<p>Sai do ponto de parada atual e dá continuidade à execução do código, normalmente. Isso não afeta outros pontos de parada que não tenham sido parados ainda.</p>

<p>Use o <code class="inline">Continue</code> quando o ponto de parada atual não for útil e você quiser dar continuidade à execução do código.</p>

<h4><em>Step Over</em></h4>

<p>Navegue pelo código, linha-por linha (uma linha por clique) até alcançar a chamada de uma função. Nesse ponto, "passamos pela" função, mas não acessamos o código interno daquela função em particular.</p>

<p>Use o <code class="inline">Step Over</code> quando aquilo que precisar ser resolvido está relacionado à função atual e precisa verificar chamadas a funções externas.</p>

<h4><a name="user-content-step-into" href="https://github.com/valueof/beautifuljavascript/blob/master/modern-debugging-experience.asciidoc#step-into"/><strong><em>Step Into</em></strong></a></h4>

<p>Semelhante ao <code class="inline">Step Over</code>, exceto que, neste caso, você acessa a primeira linha do código da função.</p>

<p>Use o <code class="inline">Step Into</code> quando estiver interessado em execução linha-a-linha, assim como chamadas a funções externas.</p>

<h4><strong><em>Step Out</em></strong></h4>

<p>Ao entrar em uma função, o <code class="inline">Step Out</code> continuará a execução do resto daquela função, porém, o código não será depurado.</p>

<p>Use o <code class="inline">Step Out</code> quando não tiver interesse no resto da função atual e quer continuar a depuração imediatamente fora dela.</p>

<h3>A Pilha de Execução</h3>

<p>A pilha de execução fica ativa enquanto estiver parada em um ponto de parada. O caminho da execução que leva até o ponto de parada atual é mostrado na pilha de execução, sendo que a execução do topo é a mais recente.</p>

<p>Cada chamada dentro da pilha contem:</p>

<ul>
  <li>Nome da função</li>
  <li>Nome do arquivo contendo a função</li>
  <li>A linha de código onde a função reside</li>
</ul>

<p>Clique em qualquer chamada dentro da pilha para navegar até o ponto do código fonte onde a função relevante estará destacada. Para copiar o rastreamento da pilha para sua área de transferência, basta <strong>clicar com o botão direito</strong> em uma chamada e selecionar <strong>Copy stack trace</strong>. No menu de contexto da pilha de execução, você também pode selecionar <strong>Restart Frame</strong>.</p>

<h3>Reescrevendo Funções Enquanto Parado em um Ponto de Parada</h3>

<p>Considere o caso de uso que o depurador esteja parado no meio de uma função <em>callback</em> ativada por um manipulador de evento de clique, e que você está tentando descobrir o porque o reestabelecimento de <code>target</code> não estar funcionando como esperado. </p>

<p>Veja que foi feita uma tentativa de acessar a propriedade <code>target</code> como parte da palavra-chave <code>this</code>, mas você lembrar que é uma propriedade parte do objeto do evento passado como parte da função <em>calback</em>. </p>

<p>Você pode reescrever a função usando a Edição em Tempo Real para verificar que suas mudanças realmente funcionam e que o novo JavaScript foi injetado no motor V8 do navegador.</p>

<h3><em>monitorEvents</em></h3>

<p>Ao escrever um manipulador de ventos para um evento como o de rolagem, você talvez comece usando o método <code>console.log</code> para ver como o argumento passado (o objeto do evento) é. Uma dica para conseguir isso é usar o atalho <code>monitorEvents</code>. Cole o código abaixo no <strong>Painel <em>Console</em></strong> e, então, mexa a barra de rolagem da página:</p>

<pre class="brush: javascript">monitorEvents(window, "resize");</pre>

<p>Perceba que o objeto evento é registrado no <em>console</em>, pronto para inspeção.</p>

<h3><em>Debug</em></h3>

<p>Quando quiser que o depurador pare na primeira linha de uma função, durante sua execução, você pode fazer de uma dessas duas maneiras:</p>

<ul>
  <li>Adicionar um ponto de parada através da interface de usuário das Ferramentas para Desenvolvedores.</li>
  <li>Adicionar um comando de depuração à função.</li>
</ul>

<p>Outra técnica é executar a função <code>debug(fn)</code> que faz parte da API da Linha de Comando. A função leva como argumento a função que você deseja depurar e parará na primeira linha de execução daquela função.</p>

<h3>Parada no Acesso a Propriedades</h3>

<p>Essa técnica permite que pause o depurador quando uma propriedade de um objeto que você estiver interessado for acessada de qualquer forma (leitura ou escrita). Para parar quando uma propriedade de um objeto for lida ou escrita, execute o comando trecho de código abaixo (através do <strong>Panel <em>Console</em></strong> ou <strong>Snippets</strong> - <em>Trechos de Código</em>):</p>

<pre class="brush: javascript">Object.defineProperty(document.body, 'scrollTop', {
	get: function () {
		debugger;
	},
	set: function (val) {
		debugger;
	}
});</pre>

<p>O trecho aplica um <code>getter</code> e um <code>setter</code> à propriedade <code class="inline">scrollTop</code> do objeto <code>document.body</code>. Nos <code>getter</code> e <code>setter</code> customizados, o o comando do depurador existe. Você também pode usar <code>Object.observe</code> para parar em adições à propriedade de um objeto especificado:</p>

<pre class="brush: javascript">var watchMe = {};
Object.observe(watchMe, function() {
  debugger;
});</pre>

<h3>Pontos de Parada Condicionais Usando <code>console.log</code></h3>

<p>Além da palavra chave <code>debugger</code>, para configurar um ponto de parada através das Ferramentas para Desenvolvedores, você pode clicar na borda da linha de código onde quer que o depurador pare. Esse método de configurar uma parada tem uma funcionalidade extra: Configurar um ponto de parada condicional, onde você instrui as Ferramentas para Desenvolvedores para parar ali, somente se uma certa expressão resultar em verdadeiro. Por exemplo, você pode configurar um ponto de parada condicional para parar somente se existir um argumento de erro.</p>

<p>Para configurar uma parada condicional:</p>

<ol>
  <li><strong>Clique com botão direito</strong> dentro da borda da linha;</li>
  <li>Selecione <strong>Add conditional breakpoint</strong>;</li>
  <li>Digite a expressão que você deseja que as Ferramentas para Desenvolvedores avaliem;</li>
  <li>Aperte <strong>Enter</strong></li>
</ol>

<figure class="post_image">
  <img alt="Add conditional breakpoint" src="https://s3.amazonaws.com/cms-assets.tutsplus.com/uploads/users/329/posts/22584/image/md-conditional-breakpoint.png"/>
</figure>

<p>Você pode usar a técnica de ponto de parada condicional para adicionar, rapidamente, um comando <code>console.log</code> como uma expressão a ser avaliada. Como o comando <code>console.log</code> resulta em <code>undefined</code>, as Ferramentas para Desenvolvedores não para, mas, uma vez que a expressão é executada, você pode inspecionar as variáveis daquele momento, dessa forma.</p>

<h3>Usando Expressões Observadoras</h3>

<p>Quando o depurador está parado em um ponto de parada, você pode abrir o <strong>Painel <em>Console</em></strong> no modo "engavetado", pressionando a tecla <strong>Esc</strong>. O código que você digitar será avaliado no mesmo contexto do ponto em que você está parado, significando que todas as variáveis daquele escopo estarão acessíveis.</p>

<figure class="post_image">
  <img alt="Watch expressions" src="https://s3.amazonaws.com/cms-assets.tutsplus.com/uploads/users/329/posts/22584/image/md-watch-expressions.png"/>
</figure>

<p>Uma expressão observadora é uma ferramenta para simplificar a técnica de inspeção regular (através do <code>console.log</code>, por exemplo) de variáveis de escopo. <em>Watch Expressions</em> é um painel dentro do <em>Painel Sources</em>. Você pode adicionar ou remover Expressões Observadores usando os botões de <strong>+</strong> e <strong>-</strong>. Um objeto típico a se observar é o objeto <code>this</code>; perceba como ele se refere ao objeto objeto global <code>window</code> quando não está em um ponto de parada.</p>

<p>Expressões Observadores geralmente serão atualizadas de acordo com que você navega pelo código. Se não atualizar, clique no botão <strong>Refresh</strong>.</p>

<h4>Exceções</h4>

<p>Considere o código a seguir:</p>

<pre class="brush: javascript">function a() {
return b();
}

function b() {
    return c();
}

function c() {
    console.trace('O Rastreio');
    return 42;
}

a();</pre>

<figure class="post_image">
  <img alt="Exceptions" src="https://s3.amazonaws.com/cms-assets.tutsplus.com/uploads/users/329/posts/22584/image/md-console-trace.png"/>
</figure>

<p>Foram declaradas três funções. A função <code>a</code> invoca a função <code>b</code> que, por sua vez, invoca a função <code>c</code>. O código inicia a cadeia com uma chamada à função <code>a</code>. O comando <code>console.trace</code> registra a pilha de rastreio do <code>console</code> onde o método foi chamado. Usar o <code>console.trace</code> mostrar o retorno de <code class="inline">console.trace</code>.</p>

<p>Note que os nomes das funções e as linhas onde foram invocadas são mostrados na mensagem de rastreio. Você pode clicar no número da linha para ser levado até o ponto relevante do código fonte, através do <em>Painel Sources</em>. Essa técnica também funciona para os trechos de códigos (<em>snippets</em>).</p>

<p>O depurador oferece vários modos para lidar com Exceções:</p>

<ul>
  <li>Parar em exceções não tratadas;</li>
  <li>Parar em exceções tratadas e não tratadas;</li>
  <li>Não parar em exceções</li>
</ul>

<h2><span class="sectionnum">2.</span> Depurando de Dentro para Fora</h2>

<p>Quando tiver de depurar um site que você souber pouca coisa sobre o mesmo, poderá usar uma técnica diferente de depuração. Nessa abordagem, você se fixa a eventos que acredita que serão ativados e requisita às Ferramentas para Desenvolvedores que pare em tais eventos se e quando eles ocorrerem. Há duas categorias de pontos de entrada de "De Fora &gt; Para Dentro":</p>

<ul>
  <li>Modificações da DOM</li>
  <li>Pontos de Parada para Observadores de Eventos</li>
</ul>

<h3>Parada em Modificações da DOM</h3>

<p>Você tem a tarefa de depurar uma página web, mais especificamente sua DOM. Os nodos são adicionados e removidos durante o ciclo de vida da página e você precisa inspecionar o código JavaScript que faz isso acontecer. Configure um ponto de parada da DOM com os seguintes passos:</p>

<ul>
  <li>Clique com botão direito em um elemento da DOM no <em>Painel Elements</em>;</li>
  <li>Selecione o ponto de parada preferido da DOM do menu de contexto <strong>Break on</strong>;</li>
  <li>Enquanto estiver em um ponto de parada, você pode ver uma mensagem que explica o motivo do depurador ter parado, como visto em <em>Reason</em> para parar em um ponto de parada.</li>
</ul>

<figure class="post_image">
  <img alt="DOM modifications" src="https://s3.amazonaws.com/cms-assets.tutsplus.com/uploads/users/329/posts/22584/image/md-debugger-reason.png"/>
</figure>

<p>Toda vez que você configura um ponto de parada da DOM, você pode ativá-lo ou desativá-lo facilmente, na aba <strong>DOM breakpoints</strong> no <strong>Painel Elements</strong>. Nesta aba, cada ponto de parada que você configurou está listado e você pode interagir com essa aba das seguintes formas:</p>

<ul>
  <li>Marcar/desmarcar a caixa de seleção para habilitar/desabilitar o ponto de parada;</li>
  <li>Clicar no nome do Nodo (o qual está sublinhado) para navegar até ele na visualização em árvore da DOM;</li>
  <li><strong>Clique com o botão direito</strong> e selecione <strong>Remove All DOM breakpoints</strong> para desabilitar e remover todos os pontos de parada da DOM.</li>
</ul>

<figure class="post_image">
  <img alt="DOM breakpoints" src="https://s3.amazonaws.com/cms-assets.tutsplus.com/uploads/users/329/posts/22584/image/md-dom-breakpoints-pane.png"/>
</figure>

<h4><strong>Modificações de Subárvore</strong> </h4>

<p><em>Descrição:</em> Uma modificação de subárvore ocorre quando a árvore de um nodo raiz (o qual possui um ponto de parada configurado) é modificada. Isso abrange a adição ou remoção de nodos.</p>

<p><em>Caso de Uso:</em> Uma <code class="inline">div</code> recipiente está presente na DOM e uma requisição Ajax acontece durante o carregamento da página, a qual adiciona alguns nodos novos no recipiente original. Adicione um ponto de parada de Modificação de Subárvore na <code>div</code> recipiente para ver o exato momento do código que adiciona novos nodos à DOM.</p>

<p><em>Exemplos de Mensagens:</em> Parado em um ponto de parada de <code class="inline">Modificação de Subárvore</code> configurada na <em>tag</em> <code class="inline">body</code> porque seu descendente <code class="inline">p</code> foi removido. Ou: Parado em um ponto de parada de <code class="inline">Modificação de Subárvore</code> configurado em <code class="inline">div#parent</code> porque um novo filho foi adicionado àquele nodo.</p>

<h4><strong>Atributos Modificados</strong> </h4>

<p><em>Descrição:</em> Uma parada de modificação de atributo é ativada quando o nome ou valor de um atributo em um nodo é adicionado, removido ou modificado. Isto inclui todos os atributos, como <code>class</code>, <code>data-*</code> ou <code>style</code>.</p>

<p><em>Caso de Uso:</em> Uma mudança visual acontece na página em um momento aleatório e você consegue descobrir que é devido a uma classe que é adicionada dinamicamente ao elemento <code>body</code>. Você quer investigar quem e o porque da adição dessa classe.</p>

<p><em>Exemplos de mensagem:</em> Parado em um ponto de parada de <code class="inline">Atributos Modificados</code> configurado em um elemento <code class="inline">p</code>.</p>

<h4><strong>Remoção de Nodo</strong> </h4>

<p><em>Descrição:</em> Um ponto de parada de remoção de nodo é ativado no ponto em que um nodo é removido do elemento pai que o ponto de parada é configurado.</p>

<p><em>Caso de Uso:</em> Você está criando um aplicativo de lista de tarefas e quer verificar que, quando o usuário apaga um item da lista, ele também seja removido da lista da DOM. Você pode configurar um ponto de parada de remoção de nodo para garantir que este comportamento ocorra.</p>

<p><em>Exemplos de Mensagem:</em> Parado em um <code class="inline">Nodo Removido</code> <code class="inline">div#container</code>.</p>

<h3>Pontos de Parada de Observadores de Eventos</h3>

<p>Nas Ferramentas para Desenvolvedores, um número pré-determinado de pontos de parada para Observadores de Eventos que você pode habilitar. Eles oferecem portas de entrada ao JavaScript que pertence à página.</p>

<p>Considere uma simples página <code class="inline">about:blank</code>. Configure um ponto de parada de observador de evento do tipo <code>click</code> nesta página, seguindo os passos abaixo:</p>

<ul>
  <li>Navegue até a aba <strong>Event Listener Breakpoints</strong> no <strong>Painel Sources</strong>;</li>
  <li>Abra a categoria de Observadores de Evento <code class="inline">Mouse</code>;</li>
  <li>Habilite o observador de evento <code class="inline">Click</code></li>
</ul>

<p>Agora, você tem um ponto de parada configurado. Se você clicar na página, perceberá que nada acontece. Agora, execute o trecho de código JavaScript a seguir no <strong>Painel Console</strong>.</p>

<pre class="brush: javascript">document.addEventListener('click', console.log.bind(console))</pre>

<p>Quando você criar um ponto de parada para o mesmo evento que você registrou um observador de evento, o depurador para antes do ponto onde sua função <em>callback</em> do observador de eventos é executada.</p>

<p>Você pode registrar pontos de parada para vários tipos de eventos como temporizadores, eventos de toque e outros, que estão listados na tabela abaixo.</p>

<table>
  <thead>
    <tr>
      <th>Categoria de Evento</th>
      <th>Exemplos de Evento</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><p>Animação</p></td>
      <td><p>requestAnimationFrame, cancelAnimationFrame, animationFrameFired</p></td>
    </tr>
    <tr>
      <td><p>Controle</p></td>
      <td><p>resize, scroll, zoom, focus, blur, select, change, submit, reset</p></td>
    </tr>
    <tr>
      <td><p>Área de Transferência</p></td>
      <td><p>copy, cut, paste, beforecopy, beforecut, beforepaste</p></td>
    </tr>
    <tr>
      <td><p>Mutação da DOM</p></td>
      <td><p>DOMActivate, DOMFocusIn, DOMFocusOut, DOMAttrModified, DOMCharacterDataModified, DOMNodeInserted, DOMNodeInsertedIntoDocument, DOMNodeRemoved, DOMNodeRemovedFromDocument, DOMSubtreeModified, DOMContentLoaded</p></td>
    </tr>
    <tr>
      <td><p>Aparelho</p></td>
      <td><p>deviceorientation, devicemotion</p></td>
    </tr>
    <tr>
      <td><p>Arrastar / Soltar</p></td>
      <td><p>dragenter, dragover, dragleave, drop</p></td>
    </tr>
    <tr>
      <td><p>Teclado</p></td>
      <td><p>keydown, keyup, keypress, input</p></td>
    </tr>
    <tr>
      <td><p>Carregamento</p></td>
      <td><p>load, beforeunload, unload, abort, error, hashchange, popstate</p></td>
    </tr>
    <tr>
      <td><p>Mouse</p></td>
      <td><p>click, dblclick, mousedown, mouseup, mouseover, mousemove, mouseout, mousewheel, wheel</p></td>
    </tr>
    <tr>
      <td><p>Temporizador</p></td>
      <td><p>setTimer, clearTimer, timerFired</p></td>
    </tr>
    <tr>
      <td><p>Toque</p></td>
      <td><p>touchstart, touchmove, touchend, touchcancel</p></td>
    </tr>
    <tr>
      <td><p>WebGL</p></td>
      <td><p>webglErrorFired, webglWarningFired</p></td>
    </tr>
  </tbody>
</table>

<p>A técnica de "depuração de fora para dentro" pode ser bem útil ao tentar depurar sites de terceiros cuja funcionalidade está comprometida ou mesmo quando você estiver curioso sobre como algo é feito/acontece em uma página que você está visualizando.</p>

<h2><span class="sectionnum">3.</span> Extensões</h2>

<p>Existem várias extensões para o Chrome, muitas das quais aprimoram as funcionalidades das Ferramentas para Desenvolvedores. Uma lista com os destaques pode ser vista na <a href="https://developer.chrome.com/devtools/docs/extensions-gallery">Galeria de Extensões para Ferramentas para Desenvolvedores</a>.</p>

<h3>Pré-processamento de JavaScript das Ferramentas para Desenvolvedores</h3>

<p>Para criadores de extensões para Ferramentas para Desenvolvedores, a <a href="https://code.google.com/p/chromium/wiki/ScriptPreprocessor">funcionalidade de pré-processamento de JavaScript</a> é um tópico válido a ser aprendido. O pré-processador pode interromper o código fonte JavaScript antes dele entrar no motor V8, permitindo a alteração do código fonte JavaScript através das Ferramentas para Desenvolvedores, antes dele entrar na máquina virtual, a partir de uma extensão. </p>

<p>Além dessa capacidade de interceptação, a API de pré-processamento tem acessos programáticos para recarregamento de recursos de <em>scripts</em>. Uma extensão pode, a qualquer momento de seu ciclo de vida, recarregar arquivo JavaScript fonte sem recarregar a página original.</p>

<h2><span class="sectionnum">4.</span> Node</h2>

<p>Essa seção cobre algumas ferramentas que oferecem um certo nível de integração entre o <a href="http://nodejs.org/">Node.js</a> e as Ferramentas para Desenvolvedores do Chrome.</p>

<h3>Node Inspector</h3>

<p>Há duas partes das Ferramentas para Desenvolvedores:</p>

<ul>
  <li><strong>Front-end</strong>: É essa parte que você usa e interage. É composta de HTML, CSS e JavaScript.</li>
  <li><strong>Back-end</strong>: No caso de inspecionar uma página usando o Google Chrome, o <em>back-end</em> fica dentro do próprio Chrome. As mensagens são passadas e devolvidas através do <a href="https://developer.chrome.com/devtools/docs/debugger-protocol">Protocolo de Depuração Remota</a>.</li>
</ul>

<p>Qualquer aplicação pode implementar algum tipo de comunicação através do protocolo de depuração remota, permitindo que seus usuários possam depurá-la através das Ferramentas para Desenvolvedores. O <a href="https://github.com/node-inspector/node-inspector">Node Inspector</a> é uma dessas ferramentas. Após instalá-lo, você pode executar qualquer código do Node.js usando o <em>Node Inspector</em>. A ferramenta inicial um servidor web que hospedará o <em>front-end</em> das Ferramentas para Desenvolvedores. Essa versão especial das Ferramentas para Desenvolvedores não usa o <em>back-end</em> do Chrome, mas, sim, o do próprio <em>Node Inspector</em>.</p>

<figure class="post_image">
  <img alt="Node Inspector" src="https://s3.amazonaws.com/cms-assets.tutsplus.com/uploads/users/329/posts/22584/image/md-node-inspector.png"/>
</figure>

<p>Como pode ver no <em>Node Inspector</em>, as Ferramentas para Desenvolvedores está em um ponto de parada. A pilha de execução se refere às chamadas realizadas no Node.js. O único envolvimento com o navegador aqui é para a interface das Ferramentas para Desenvolvedores.</p>

<h3>Node Heapdump</h3>

<p>Use o <a href="https://github.com/bnoordhuis/node-heapdump">Node Heapdump</a> para realizar capturas da árvore de execução da máquina V8 em um dado ponto do seu código. O estado atual da árvore do V8 será serializado e retornado em um arquivo.</p>

<figure class="post_image">
  <img alt="Node Heapdump" src="https://s3.amazonaws.com/cms-assets.tutsplus.com/uploads/users/329/posts/22584/image/md-node-heapdump.png"/>
</figure>

<p>Compare duas capturas de árvores de execução para descobrir quais objetos não estão sendo colecionados. Isso é útil para verificar vazamentos de memórias.</p>

<h3>Conclusão</h3>

<p>E é isso! Chegamos ao fim dessa série de contato com depuração moderna. Espero que você esteja confortável criando e depurando código JavaScript dentro das Ferramentas para Desenvolvedores. Você agora está familiarizado com fluxos de trabalho que podem ajudar na depuração de código e também sabe lidar com sites em produção que você nunca trabalhou antes. Tenha certeza de por em prática algumas das técnicas que você aprendeu aqui, na próxima vez que tiver de depurar algum código.</p>

<p>Obrigado pela leitura!</p>